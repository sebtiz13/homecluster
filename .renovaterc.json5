{
  // note: this json file support comment
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:best-practices",
    "config:semverAllMonthly",
    ":gitSignOff"
  ],
  "dependencyDashboardTitle": "Renovate Dashboard",
  "assigneesFromCodeOwners": true,
  "timezone": "Europe/Paris",
  "separateMajorMinor": true,
  "flux": {
    "fileMatch": [
      "kubernetes/.+/helm-?release\\.ya?ml$",
      "flux-system/.+\\.ya?ml$",
      "charts/.+\\.ya?ml$"
    ]
  },
  "helm-values": {
    "fileMatch": [
      "kubernetes/.+/helm-?release\\.ya?ml$"
    ]
  },
  "kubernetes": {
    "fileMatch": [
      "kubernetes/.+\\.ya?ml$"
    ]
  },
  "customManagers": [
    // From https://github.com/onedr0p/home-ops/blob/6b2eb51777d20cb5ecb45a4c18c163656b28f64b/.github/renovate/customManagers.json5
    {
      "customType": "regex",
      "description": [
        "Process custom dependencies"
      ],
      "fileMatch": [
        "(^|/)ansible/.+\\.ya?ml(?:\\.j2)?$",
        "(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"
      ],
      "matchStrings": [
        // # renovate: datasource=github-releases depName=k3s-io/k3s
        // k3s_release_version: &version v1.29.0+k3s1
        // # renovate: datasource=helm depName=cilium repository=https://helm.cilium.io
        // version: 1.15.1
        "datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( repository=(?<registryUrl>\\S+))?\\n.+: (&\\S+\\s)?(?<currentValue>\\S+)",
        // # renovate: datasource=github-releases depName=rancher/system-upgrade-controller
        // https://github.com/rancher/system-upgrade-controller/releases/download/v0.13.2/crd.yaml
        "datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)\\n.+/(?<currentValue>(v|\\d)[^/]+)"
      ],
      "datasourceTemplate": "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}"
    },
    {
      "customType": "regex",
      "description": [
        "Process CloudnativePG Postgresql version"
      ],
      "fileMatch": [
        "(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"
      ],
      "matchStrings": [
        "imageName: (?<depName>\\S+):(?<currentValue>.*\\-.*)"
      ],
      "datasourceTemplate": "docker",
      "versioningTemplate": "redhat"
    }
  ],
  "regexManagers": [
    {
      "description": "Process CRD dependencies",
      "fileMatch": [
        "cluster/.+\\.ya?ml$"
      ],
      "matchStrings": [
        "registryUrl=(?<registryUrl>\\S+) chart=(?<depName>\\S+)\n.*?(?<currentValue>[^-\\s]*)\n",
        "datasource=(?<datasource>\\S+) image=(?<depName>\\S+)\n.*?-\\s(.*?)/(?<currentValue>[^/]+)/[^/]+\n"
      ],
      "datasourceTemplate": "{{#if datasource}}{{{datasource}}}{{else}}helm{{/if}}"
    },
    {
      "description": "Process various dependencies",
      "fileMatch": [
        "ansible/.+\\.ya?ml$",
        "cluster/.+\\.ya?ml$",
        ".+\\.md$"
      ],
      "matchStrings": [
        "datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( versioning=(?<versioning>\\S+))?(?<annotation> \\(\\d\\))?\n.*?\"(?<currentValue>\\S+)\"\n?"
      ],
      "datasourceTemplate": "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}",
      "versioningTemplate": "{{#if versioning}}{{{versioning}}}{{else}}semver{{/if}}"
    }
  ],
  "packageRules": [
    {
      "matchManagers": [
        "kubernetes"
      ],
      "matchDatasources": [
        "kubernetes-api"
      ],
      "enabled": false
    },
    {
      "matchPackagePatterns": [
        "flux"
      ],
      "groupName": "flux"
    },
    {
      "description": "Add attention to potential breaking change on major update",
      "matchUpdateTypes": [
        "major"
      ],
      "commitMessagePrefix": "{{semanticCommitType}}({{semanticCommitScope}})!:"
    },
    {
      "description": "Automerge minor and patch",
      "matchUpdateTypes": [
        "minor",
        "patch",
        "pin",
        "digest"
      ],
      "automerge": true
    },
    // From: https://github.com/onedr0p/home-ops/blob/6b2eb51777d20cb5ecb45a4c18c163656b28f64b/.github/renovate/packageRules.json5
    {
      "description": [
        "Custom schedule for frequently updated packages"
      ],
      "matchDataSources": [
        "docker",
        "helm"
      ],
      "matchPackagePatterns": [
        "minio",
        "reloader"
      ],
      "schedule": [
        "on the first day of the month"
      ]
    },
    {
      "description": [
        "Custom versioning for k3s"
      ],
      "matchDatasources": [
        "github-releases"
      ],
      "matchPackagePatterns": [
        "k3s"
      ],
      "versioning": "regex:^v(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)(?<compatibility>\\+k3s)(?<build>\\d+)$"
    },
    {
      "description": "Use custom versioning for Minio",
      "matchDepNames": [
        "quay.io/minio/minio",
        "quay.io/minio/mc"
      ],
      "versioning": "regex:^RELEASE\\.(?<major>\\d+)-(?<minor>\\d+)-(?<patch>\\d+)T.*Z$"
    }
  ]
}
