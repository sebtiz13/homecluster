{{- /*
Tweak from https://github.com/VictoriaMetrics/helm-charts/blob/master/charts/victoria-metrics-k8s-stack/templates/rules/vmagent.yaml
Changes:
  - add cluster to PersistentQueueIsDroppingData,
  - remove dashboard annotation
*/ -}}
{{- $VM := index .Values "victoria-metrics-k8s-stack" }}
{{- if and .Values.defaultRules.create $VM.vmagent.enabled .Values.defaultRules.rules.victoriametrics.vmagent }}
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ printf "%s-%s" (include "monitoring.fullname" .) "vmagent" | trunc 63 | trimSuffix "-" | trimSuffix "." }}
  labels: {{ include "monitoring.labels" . | nindent 4 }}
spec:
  groups:
  {{- if $VM.defaultRules.params }}
  - params:
      {{ toYaml $VM.defaultRules.params | nindent 6 }}
  {{- else }}
  - {{ end }}concurrency: 2
    interval: 30s
    name: vmagent
    rules:
    {{- if not ($VM.defaultRules.disabled.PersistentQueueIsDroppingData | default false) }}
    - alert: PersistentQueueIsDroppingData
      annotations:
        description: Vmagent dropped {{`{{`}} $value | humanize1024 {{`}}`}} from persistent queue on instance {{`{{`}} $labels.instance {{`}}`}} for the last 10m.
        summary: Instance {{`{{`}} $labels.instance {{`}}`}} is dropping data from persistent queue
      expr: sum(increase(vm_persistentqueue_bytes_dropped_total[5m])) by (job, instance, cluster) > 0
      for: 10m
      labels:
        severity: critical
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.RejectedRemoteWriteDataBlocksAreDropped | default false) }}
    - alert: RejectedRemoteWriteDataBlocksAreDropped
      annotations:
        summary: Job "{{`{{`}} $labels.job {{`}}`}}" on instance {{`{{`}} $labels.instance {{`}}`}} drops the rejected by remote-write server data blocks. Check the logs to find the reason for rejects.
      expr: sum(increase(vmagent_remotewrite_packets_dropped_total[5m])) by (job, instance, cluster) > 0
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.TooManyScrapeErrors | default false) }}
    - alert: TooManyScrapeErrors
      annotations:
        summary: Job "{{`{{`}} $labels.job {{`}}`}}" on instance {{`{{`}} $labels.instance {{`}}`}} fails to scrape targets for last 15m
      expr: sum(increase(vm_promscrape_scrapes_failed_total[5m])) by (job, instance, cluster) > 0
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.TooManyWriteErrors | default false) }}
    - alert: TooManyWriteErrors
      annotations:
        dashboard: {{ index .Values.grafana.ingress.hosts 0 }}/d/G7Z9GzMGz?viewPanel=77&var-instance={{`{{`}} $labels.instance {{`}}`}}
        summary: Job "{{`{{`}} $labels.job {{`}}`}}" on instance {{`{{`}} $labels.instance {{`}}`}} responds with errors to write requests for last 15m.
      expr: |-
        (sum(increase(vm_ingestserver_request_errors_total[5m])) by (job, instance, cluster)
        +
        sum(increase(vmagent_http_request_errors_total[5m])) by (job, instance, cluster)) > 0
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.TooManyRemoteWriteErrors | default false) }}
    - alert: TooManyRemoteWriteErrors
      annotations:
        description: "Vmagent fails to push data via remote write protocol to destination \"{{`{{`}} $labels.url {{`}}`}}\"\n Ensure that destination is up and reachable."
        summary: Job "{{`{{`}} $labels.job {{`}}`}}" on instance {{`{{`}} $labels.instance {{`}}`}} fails to push to remote storage
      expr: sum(rate(vmagent_remotewrite_retries_count_total[5m])) by(job, instance, cluster, url) > 0
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.RemoteWriteConnectionIsSaturated | default false) }}
    - alert: RemoteWriteConnectionIsSaturated
      annotations:
        description: "The remote write connection between vmagent \"{{`{{`}} $labels.job {{`}}`}}\" (instance {{`{{`}} $labels.instance {{`}}`}}) and destination \"{{`{{`}} $labels.url {{`}}`}}\" is saturated by more than 90% and vmagent won't be able to keep up.\n This usually means that `-remoteWrite.queues` command-line flag must be increased in order to increase the number of connections per each remote storage."
        summary: Remote write connection from "{{`{{`}} $labels.job {{`}}`}}" (instance {{`{{`}} $labels.instance {{`}}`}}) to {{`{{`}} $labels.url {{`}}`}} is saturated
      expr: "sum(rate(vmagent_remotewrite_send_duration_seconds_total[5m])) by(job, instance, cluster, url) \n> 0.9 * max(vmagent_remotewrite_queues) by(job, instance, cluster, url)"
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.PersistentQueueForWritesIsSaturated | default false) }}
    - alert: PersistentQueueForWritesIsSaturated
      annotations:
        description: Persistent queue writes for vmagent "{{`{{`}} $labels.job {{`}}`}}" (instance {{`{{`}} $labels.instance {{`}}`}}) are saturated by more than 90% and vmagent won't be able to keep up with flushing data on disk. In this case, consider to decrease load on the vmagent or improve the disk throughput.
        summary: Persistent queue writes for instance {{`{{`}} $labels.instance {{`}}`}} are saturated
      expr: rate(vm_persistentqueue_write_duration_seconds_total[5m]) > 0.9
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | indent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.PersistentQueueForReadsIsSaturated | default false) }}
    - alert: PersistentQueueForReadsIsSaturated
      annotations:
        description: Persistent queue reads for vmagent "{{`{{`}} $labels.job {{`}}`}}" (instance {{`{{`}} $labels.instance {{`}}`}}) are saturated by more than 90% and vmagent won't be able to keep up with reading data from the disk. In this case, consider to decrease load on the vmagent or improve the disk throughput.
        summary: Persistent queue reads for instance {{`{{`}} $labels.instance {{`}}`}} are saturated
      expr: rate(vm_persistentqueue_read_duration_seconds_total[5m]) > 0.9
      for: 15m
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.SeriesLimitHourReached | default false) }}
    - alert: SeriesLimitHourReached
      annotations:
        description: Max series limit set via -remoteWrite.maxHourlySeries flag is close to reaching the max value. Then samples for new time series will be dropped instead of sending them to remote storage systems.
        summary: Instance {{`{{`}} $labels.instance {{`}}`}} reached 90% of the limit
      expr: (vmagent_hourly_series_limit_current_series / vmagent_hourly_series_limit_max_series) > 0.9
      labels:
        severity: critical
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.SeriesLimitDayReached | default false) }}
    - alert: SeriesLimitDayReached
      annotations:
        description: Max series limit set via -remoteWrite.maxDailySeries flag is close to reaching the max value. Then samples for new time series will be dropped instead of sending them to remote storage systems.
        summary: Instance {{`{{`}} $labels.instance {{`}}`}} reached 90% of the limit
      expr: (vmagent_daily_series_limit_current_series / vmagent_daily_series_limit_max_series) > 0.9
      labels:
        severity: critical
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
    {{- if not ($VM.defaultRules.disabled.ConfigurationReloadFailure | default false) }}
    - alert: ConfigurationReloadFailure
      annotations:
        description: Configuration hot-reload failed for vmagent on instance {{`{{`}} $labels.instance {{`}}`}}. Check vmagent's logs for detailed error message.
        summary: Configuration reload failed for vmagent instance {{`{{`}} $labels.instance {{`}}`}}
      expr: |-
        vm_promscrape_config_last_reload_successful != 1
        or
        vmagent_relabel_config_last_reload_successful != 1
      labels:
        severity: warning
        {{- if .Values.defaultRules.additionalRuleLabels }}
        {{ toYaml .Values.defaultRules.additionalRuleLabels | nindent 8 }}
        {{- end }}
    {{- end }}
{{- end }}
