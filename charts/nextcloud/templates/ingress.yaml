{{- if and .Values.nextcloud.ingress.enabled (index .Values "collabora-code" "enabled") (not (index .Values "collabora-code" "ingress" "enabled")) }}
{{- $name := printf "%s-collabora-code" (include "nextcloud.fullname" .Subcharts.nextcloud) }}
{{- $version := index .Values "collabora-code" "image" "tag" }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $name }}
  labels:
    helm.sh/chart: {{ include "nextcloud.chart" .Subcharts.nextcloud }}
    {{- if $version }}
    app.kubernetes.io/version: {{ $version | quote }}
    {{- end }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- if .Values.nextcloud.ingress.labels }}
{{ toYaml .Values.nextcloud.ingress.labels | indent 4 }}
{{- end }}
{{- if .Values.nextcloud.ingress.annotations }}
  annotations:
{{ toYaml .Values.nextcloud.ingress.annotations | indent 4 }}
{{- end }}
spec:
  {{- if .Values.nextcloud.ingress.className }}
  ingressClassName: {{ .Values.nextcloud.ingress.className }}
  {{- end }}
  rules:
    - host: {{ .Values.nextcloud.nextcloud.host }}
      http:
        paths:
          # static html, js, images, etc. served from coolwsd
          # browser is the client part of LibreOffice Online
          - backend:
              service:
                name: {{ $name }}
                port:
                  name: http
            path: /browser
            {{- if eq (include "nextcloud.ingress.apiVersion" $) "networking.k8s.io/v1" }}
            pathType: Prefix
            {{- end }}
          # WOPI discovery URL
          - backend:
              service:
                name: {{ $name }}
                port:
                  name: http
            path: /hosting/discovery
            {{- if eq (include "nextcloud.ingress.apiVersion" $) "networking.k8s.io/v1" }}
            pathType: Prefix
            {{- end }}
          # Capabilities
          - backend:
              service:
                name: {{ $name }}
                port:
                  name: http
            path: /hosting/capabilities
            {{- if eq (include "nextcloud.ingress.apiVersion" $) "networking.k8s.io/v1" }}
            pathType: Prefix
            {{- end }}
          # Main websocket, Admin Console websocket and
          # Download as, Fullscreen presentation and Image upload operations
          - backend:
              service:
                name: {{ $name }}
                port:
                  name: http
            path: /cool
            {{- if eq (include "nextcloud.ingress.apiVersion" $) "networking.k8s.io/v1" }}
            pathType: Prefix
            {{- end }}
          # Compatibility with integrations that use the /lool/convert-to endpoint
          - backend:
              service:
                name: {{ $name }}
                port:
                  name: http
            path: /lool
            {{- if eq (include "nextcloud.ingress.apiVersion" $) "networking.k8s.io/v1" }}
            pathType: Prefix
            {{- end }}
{{- if .Values.nextcloud.ingress.tls }}
  tls:
{{ toYaml .Values.nextcloud.ingress.tls | indent 4 }}
{{- end -}}
{{- end }}
