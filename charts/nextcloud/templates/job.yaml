{{- if .Values.nextcloudConfig.enabled -}}
{{- with .Subcharts.nextcloud }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "nextcloud.fullname" . }}-configure-{{ .Release.Revision }}
  labels:
    app.kubernetes.io/name: {{ include "nextcloud.name" . }}-configure
    helm.sh/chart: {{ include "nextcloud.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: app
  {{- if $.Values.nextcloudConfig.annotations }}
  annotations:
{{ toYaml $.Values.nextcloudConfig.annotations | indent 4 }}
  {{- end }}
spec:
  template:
    spec:
      restartPolicy: {{ $.Values.nextcloudConfig.restartPolicy }}
      containers:
        - name: configure
          image: {{ include "nextcloud.image" . }}
          command: ['su', '-m', 'www-data', '-s', '/bin/bash', '-c']
          args:
            - {{ include "nextcloud.configure-command" $ | quote }}
          env:
            {{- include "nextcloud.env" . | trim | nindent 12 }}
          volumeMounts:
            {{- include "nextcloud.volumeMounts" . | trim | nindent 12 }}
      volumes:
        - name: nextcloud-main
        {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ if .Values.persistence.existingClaim }}{{ .Values.persistence.existingClaim }}{{- else }}{{ template "nextcloud.fullname" . }}-nextcloud{{- end }}
        {{- else }}
          emptyDir: {}
        {{- end }}
        {{- if and .Values.persistence.nextcloudData.enabled .Values.persistence.enabled }}
        - name: nextcloud-data
          persistentVolumeClaim:
            claimName: {{ if .Values.persistence.nextcloudData.existingClaim }}{{ .Values.persistence.nextcloudData.existingClaim }}{{- else }}{{ template "nextcloud.fullname" . }}-nextcloud-data{{- end }}
        {{- end }}
        {{- if .Values.nextcloud.configs }}
        - name: nextcloud-config
          configMap:
            name: {{ template "nextcloud.fullname" . }}-config
        {{- end }}
        {{- if .Values.nextcloud.phpConfigs }}
        - name: nextcloud-phpconfig
          configMap:
            name: {{ template "nextcloud.fullname" . }}-phpconfig
        {{- end }}
        {{- if .Values.nginx.enabled }}
        - name: nextcloud-nginx-config
          configMap:
            name: {{ template "nextcloud.fullname" . }}-nginxconfig
        {{- end }}
        {{- if .Values.nextcloud.extraVolumes }}
        {{ toYaml .Values.nextcloud.extraVolumes | indent 8 }}
        {{- end }}
      {{- if .Values.nginx.enabled }}
      # Will mount configuration files as www-data (id: 82) for nextcloud
      securityContext:
        fsGroup: 82
        {{- if .Values.securityContext }}
        {{- toYaml .Values.securityContext | nindent 8 }}
        {{- end }}
      {{- else }}
      # Will mount configuration files as www-data (id: 33) for nextcloud
      securityContext:
        fsGroup: 33
        {{- if .securityContext }}
        {{- toYaml .Values.securityContext | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- if .Values.rbac.enabled }}
      serviceAccountName: {{ .rbac.serviceaccount.name }}
      {{- end }}
  backoffLimit: {{ $.Values.nextcloudConfig.backoffLimit }}
{{- end -}}
{{- end -}}
