include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

variables:
  K8S_NAMESPACE: argocd
  DOMAIN_NAME: sebtiz13.fr
  # List apps want deploy (split apps with coma)
  DEPLOY_SALAMANDRE_APPS: "argo-cd"
  DEPLOY_BAKU_APPS: ""

stages:
  - test
  - build
  - deploy

helm:lint:
  stage: test
  image:
    name: alpine/helm
    entrypoint: [""]
  script:
    - ./scripts/diff-apps.sh ./scripts/lint.sh
  rules:
    - changes:
        - apps/**/*.yaml
        - charts/common-app/**/

helm:build:
  stage: build
  image:
    name: alpine/helm
    entrypoint: [""]
  script:
    - ./scripts/diff-apps.sh ./scripts/build.sh
  needs: [helm:lint]
  artifacts:
    expire_in: 2 minutes
    paths:
      - manifests/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - apps/**/*.yaml
        - charts/common-app/**/*

git:push:
  stage: deploy
  image:
    name: alpine/git
    entrypoint: [""]
  needs: [helm:build]
  before_script:
    # set remote URL to https://oauth2:<AccessToken>@server.com/project.git
    - CI_PUSH_REPO=`echo "$CI_REPOSITORY_URL $GIT_ACCESS_TOKEN" | sed 's|^.*@\(.*\)\s\(.*\)|https://oauth2:\2@\1|g'`
    - git config http.sslverify false
    - git remote set-url --push origin "${CI_PUSH_REPO}"
    # in order to commit we have to have a user set
    # this would also make it easy to distinct the CI-made commits
    - git config user.name "CI Pipeline"
    - git config user.email "cipipeline@example.com"
  script:
    - git add manifests/**/*.yaml
    - 'git commit -m "build: deploy manifests"'
    - git push origin HEAD:$CI_COMMIT_REF_NAME
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - apps/**/*.yaml
        - charts/common-app/**/*

deploy:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  before_script:
    # Skip TLS, used only for VM
    - '[ -z "$K8S_PROXY_URL" ] || kubectl config set-cluster gitlab --server="${K8S_PROXY_URL}" --insecure-skip-tls-verify=true'
    - kubectl config use-context $CI_PROJECT_PATH:gitops
  script:
    - ./scripts/deploy.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - manifests/**/*.yaml

secret_detection:
  artifacts:
    expire_in: 1 week
