- name: Install and Configure DynDNS
  hosts: baku
  become: true
  tags: dyndns
  roles:
    - role: baku_dyndns
      when: env == 'prod'

- name: Create ArgoCD access
  hosts: baku
  tags: kubernetes
  roles:
    - role: argocd_cluster
      delegate_to: localhost
      tags: argocd
      vars:
        cluster_name: baku
        cluster_url: "https://{{ domain_name }}:6443"
  tasks:
    - name: Create kubed sync namespace
      delegate_to: localhost
      tags: kubed
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig.dest }}"
        state: present
        resource_definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "kubed-sync"

- name: Configure salamandre kubed access to baku cluster
  hosts: salamandre
  tags:
    - kubernetes
    - kubed
  roles:
    - role: kubed_cluster
      delegate_to: localhost
      when: "(ansible_limit is not defined) or ('baku' in ansible_limit)"
      vars:
        cluster_kubeconfig: "{{ hostvars.baku.kubeconfig.dest | default('') }}"
        cluster_namespace: "kubed-sync"

- name: Configure tls secret
  hosts: baku
  tags:
    - kubernetes
    - kubed
  tasks:
    - name: Wait until secret is synced
      delegate_to: localhost
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig.dest }}"
        kind: Secret
        name: "{{ root_domain | replace('.', '-') }}-tls"
        namespace: kubed-sync
        wait: true
        wait_sleep: 10
        wait_timeout: 360
    - name: Annotate secret for sync cross namespace
      delegate_to: localhost
      kubernetes.core.k8s:
        state: patched
        kubeconfig: "{{ kubeconfig.dest }}"
        kind: Secret
        name: "{{ root_domain | replace('.', '-') }}-tls"
        namespace: kubed-sync
        force: true
        definition:
          metadata:
            annotations:
              kubed.appscode.com/sync: "domain={{ root_domain }}"

- name: Install infrastructure applications
  hosts: baku
  tags: kubernetes
  roles:
    - role: apps_system
      delegate_to: localhost
      tags: common
    - role: baku_infrastructure
      delegate_to: localhost
