- name: Install and Configure DynDNS
  hosts: baku
  become: true
  tags: dyndns
  roles:
    - role: baku_dyndns
      when: env == 'prod'

- name: Create ArgoCD access
  hosts: baku
  tags: kubernetes
  roles:
    - role: argocd_cluster
      delegate_to: localhost
      tags: argocd
      vars:
        cluster_name: baku
        cluster_url: "https://{{ domain_name }}:6443"
  tasks:
    - name: Create Config Syncer sync namespace
      delegate_to: localhost
      tags: config-syncer
      kubernetes.core.k8s:
        kubeconfig: "{{ local_kubeconfig }}"
        state: present
        resource_definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "config-syncer-sync"

- name: Configure salamandre Config Syncer access to baku cluster
  hosts: salamandre
  tags:
    - kubernetes
    - config-syncer
  roles:
    - role: cs_cluster
      delegate_to: localhost
      when: "(ansible_limit is not defined) or ('baku' in ansible_limit)"
      vars:
        cluster_kubeconfig: "{{ hostvars.baku.local_kubeconfig | default('') }}"
        cluster_namespace: "config-syncer-sync"

- name: Configure tls secret
  hosts: baku
  tags:
    - kubernetes
    - config-syncer
  tasks:
    - name: Wait CA until secret is synced
      when: env == 'dev'
      delegate_to: localhost
      kubernetes.core.k8s_info:
        kubeconfig: "{{ local_kubeconfig }}"
        kind: Secret
        name: vm-ca-tls-secret
        namespace: config-syncer-sync
        wait: true
        wait_sleep: 10
        wait_timeout: 360
    - name: Annotate CA secret for sync cross namespace
      when: env == 'dev'
      delegate_to: localhost
      kubernetes.core.k8s:
        state: patched
        kubeconfig: "{{ local_kubeconfig }}"
        kind: Secret
        name: vm-ca-tls-secret
        namespace: config-syncer-sync
        force: true
        definition:
          metadata:
            annotations:
              kubed.appscode.com/sync: "domain={{ root_domain }}"
    - name: Wait until tls secret is synced
      delegate_to: localhost
      kubernetes.core.k8s_info:
        kubeconfig: "{{ local_kubeconfig }}"
        kind: Secret
        name: "{{ root_domain | replace('.', '-') }}-tls"
        namespace: config-syncer-sync
        wait: true
        wait_sleep: 10
        wait_timeout: 360
    - name: Annotate tls secret for sync cross namespace
      delegate_to: localhost
      kubernetes.core.k8s:
        state: patched
        kubeconfig: "{{ local_kubeconfig }}"
        kind: Secret
        name: "{{ root_domain | replace('.', '-') }}-tls"
        namespace: config-syncer-sync
        force: true
        definition:
          metadata:
            annotations:
              kubed.appscode.com/sync: "domain={{ root_domain }}"

- name: Install infrastructure applications
  hosts: baku
  tags: kubernetes
  roles:
    - role: apps_system
      delegate_to: localhost
      tags: common
    - role: baku_infrastructure
      delegate_to: localhost
