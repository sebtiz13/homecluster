- name: Kubernetes | Retrieve service account JWT
  kubernetes.core.k8s_info:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Secret
    name: vault-auth-secret
    namespace: external-secrets
    wait: true
  register: vault_jwt

- name: Vault | Configure kubernetes auth for baku
  delegate_to: salamandre
  vars:
    kubeconfig: "{{ lookup('file', local_kubeconfig) | from_yaml }}"
  ansible.builtin.uri:
    url: "{{ hostvars.salamandre.vault_api_url }}/auth/baku-cluster/config"
    method: POST
    status_code:
      - 204 # When successfull
      - 200 # When warning
    body_format: json
    headers:
      X-Vault-Token: "{{ hostvars.salamandre.vault_root_token }}"
    body:
      token_reviewer_jwt: "{{ vault_jwt.resources.0.data.token | b64decode }}"
      kubernetes_host: "{{ kubeconfig.clusters.0.cluster.server }}"
      kubernetes_ca_cert: "{{ vault_jwt.resources.0.data['ca.crt'] | b64decode }}\n"
