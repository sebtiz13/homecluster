- name: Cert-manager | Deploy manifest
  delegate_to: localhost
  tags:
    - cert-manager
    - tls
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/cert-manager.yaml"
    namespace: "{{ argocd_namespace }}"

- name: Cert-manager | Store CA (dev) # noqa: var-naming[no-role-prefix]
  when: env == 'dev'
  vars:
    validate_certs: false
    secrets:
      - path: tls/vm-ca
        data:
          crt: "{{ lookup('ansible.builtin.file', ca.cert) }}"
          key: "{{ lookup('ansible.builtin.file', ca.key) }}"
  ansible.builtin.import_role:
    name: vault_secrets

- name: Cert-manager | Store issuer credentials (prod) # noqa: var-naming[no-role-prefix]
  when: env == 'prod'
  vars:
    validate_certs: false
    secrets:
      - path: cert-manager/ovh
        data:
          applicationKey: "{{ cert_manager_ovh_auth.application_key }}"
          applicationSecret: "{{ cert_manager_ovh_auth.application_secret }}"
          consumerKey: "{{ cert_manager_ovh_auth.consumer_key }}"
  ansible.builtin.import_role:
    name: vault_secrets
