- name: Cert Manager | Store CA in cluster (dev)
  when: env == 'dev'
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/cert-manager.yaml') | from_yaml }}"
    namespace: "{{ manifest.spec.destination.namespace }}"
  block:
    - name: Cert Manager | Create namespace
      kubernetes.core.k8s:
        kubeconfig: "{{ local_kubeconfig }}"
        state: present
        resource_definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
    - name: Cert Manager | Store CA in cluster
      kubernetes.core.k8s:
        kubeconfig: "{{ local_kubeconfig }}"
        template: s_cm_ca_tls.yaml.j2
        namespace: "{{ namespace }}"
        validate:
          fail_on_error: true

- name: Cert Manager | Deploy manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/cert-manager.yaml"
    namespace: "{{ argocd_namespace }}"
