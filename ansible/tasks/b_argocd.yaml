- name: ArgoCD | Create service account and token
  vars:
    sa_name: argocd-manager
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    template: b_argocd/serviceaccount.yaml.j2
    namespace: kube-system

- name: ArgoCD | Create RBAC resources
  vars:
    sa_name: argocd-manager
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    template: b_argocd/rbac.yaml.j2
    namespace: kube-system

- name: ArgoCD | Retrieve generated service account token
  kubernetes.core.k8s_info:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Secret
    name: argocd-manager-token
    namespace: kube-system
  register: argocd_sa_token

- name: ArgoCD | Configure baku cluster in salamandre ArgoCD
  delegate_to: salamandre
  ansible.builtin.uri:
    url: "{{ hostvars.salamandre.argocd_api_url }}/clusters"
    headers:
      Authorization: "Bearer {{ hostvars.salamandre.argocd_api_token }}"
    method: POST
    status_code: 200
    body_format: json
    body:
      name: "{{ cluster_name }}"
      server: "{{ cluster_url }}"
      config:
        bearerToken: "{{ argocd_sa_token.resources.0.data.token | b64decode }}"
        tlsClientConfig:
          caData: "{{ argocd_sa_token.resources.0.data['ca.crt'] }}"
