- name: Deploy Zitadel
  tags: zitadel
  ansible.builtin.import_tasks: zitadel.yaml

- name: Configure Zitadel resources
  tags: zitadel
  ansible.builtin.import_tasks: zitadel_setup.yaml

- name: Configure Vault OIDC
  tags: vault
  ansible.builtin.import_tasks: vault_oidc.yaml

- name: ArgoCD | Create OIDC access # noqa: var-naming[no-role-prefix]
  tags: argocd
  ansible.builtin.include_role:
    name: oidc_access
  vars:
    secret_path: argocd/oidc
    project_id: "{{ zitadel_dev_project_id }}"
    app_name: ArgoCD
    redirect_uris:
      - "{{ argocd_host }}/auth/callback"
      - http://localhost:8085/*
    post_logout_redirect_uris:
      - "{{ argocd_host }}"
    response_types:
      - OIDC_RESPONSE_TYPE_CODE
    grant_types:
      - OIDC_GRANT_TYPE_AUTHORIZATION_CODE
      - OIDC_GRANT_TYPE_REFRESH_TOKEN
    auth_method_type: OIDC_AUTH_METHOD_TYPE_BASIC

- name: Forgejo | Create OIDC access # noqa: var-naming[no-role-prefix]
  tags: forgejo
  ansible.builtin.include_role:
    name: oidc_access
  vars:
    _manifest: "{{ lookup('file', manifests_folder + '/forgejo.yaml') | from_yaml }}"
    _host: "https://{{ _manifest.metadata.annotations['sebtiz13.fr/host'] }}"
    secret_path: forgejo/oidc
    project_id: "{{ zitadel_dev_project_id }}"
    app_name: Forgejo
    redirect_uris:
      - "{{ _host }}/user/oauth2/zitadel/callback"
    post_logout_redirect_uris:
      - "{{ _host }}/user/login"
    response_types:
      - OIDC_RESPONSE_TYPE_CODE
    grant_types:
      - OIDC_GRANT_TYPE_AUTHORIZATION_CODE
      - OIDC_GRANT_TYPE_REFRESH_TOKEN
    auth_method_type: OIDC_AUTH_METHOD_TYPE_BASIC
