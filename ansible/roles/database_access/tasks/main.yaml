- name: Generate an password
  ansible.builtin.set_fact:
    _password: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits']) }}"

- name: Store credentials # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: vault_secret
  vars:
    updatable: false
    path: "{{ secret_path }}"
    data:
      database: "{{ database }}"
      username: "{{ username }}"
      password: "{{ _password }}"

- name: Create role and database
  when: vault_check.status == 404
  delegate_to: localhost
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ local_kubeconfig }}"
    namespace: database
    pod: "postgres{{ postgres_version }}-1"
    command: >-
      psql -c "\set AUTOCOMMIT on\n
      CREATE ROLE '{{ username }}' WITH LOGIN PASSWORD '{{ _password }}';
      CREATE DATABASE '{{ database }}' OWNER '{{ username }}';"
  register: database_cmd
  changed_when: database_cmd.rc == 0
  failed_when: database_cmd.rc != 0
