- name: Restart server application
  delegate_to: "{{ inventory_hostname }}"
  vars:
    cmd_args: "-n '{{ apps_argocd.namespace }}' 'deployment/{{ apps_argocd.release_name }}-server'"
  ansible.builtin.shell: >-
    kubectl rollout restart {{ cmd_args }} >/dev/null &&
    kubectl rollout status {{ cmd_args }} >/dev/null
  changed_when: false

- name: Delete initial admin password secret
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Secret
    name: "{{ argocd_initial_admin_password.resources.0.metadata.name }}"
    namespace: "{{ argocd_initial_admin_password.resources.0.metadata.namespace }}"
    state: absent

- name: Recreate auth token
  delegate_to: "{{ inventory_hostname }}"
  ansible.builtin.uri:
    url: "http://{{ argocd_server.resources.0.spec.clusterIP }}/api/v1/session"
    method: POST
    return_content: true
    status_code: 200
    body_format: json
    body:
      username: admin
      password: "{{ admin_passwords.argocd }}"
  register: argocd_admin_auth
