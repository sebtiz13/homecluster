- name: Store VM CA in cluster
  when: env == 'dev'
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/cert-manager.yaml') | from_yaml }}"
    namespace: '{{ manifest.spec.destination.namespace }}'
  block:
    - name: Create namespace
      kubernetes.core.k8s:
        kubeconfig: '{{ kubeconfig.dest }}'
        state: present
        resource_definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: '{{ namespace }}'

    - name: Store VM CA in cluster
      kubernetes.core.k8s:
        kubeconfig: '{{ kubeconfig.dest }}'
        template: vm_ca_tls.yaml.j2
        namespace: '{{ namespace }}'
        validate:
          fail_on_error: true

- name: Deploy application manifest
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig.dest }}'
    state: present
    src: '{{ manifests_folder }}/cert-manager.yaml'
    namespace: '{{ apps_argocd.namespace }}'
