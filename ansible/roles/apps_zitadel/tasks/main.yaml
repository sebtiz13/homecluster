- name: Store masterkey # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: vault_secret
  vars:
    updatable: false
    path: salamandre/data/zitadel/masterkey
    data:
      value: "{{ lookup('file', credentials_folder + '/zitadel_masterkey') }}"
- name: Create database access # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: database_access
  vars:
    secret_path: salamandre/data/zitadel/database
    database: zitadel
    username: zitadel

- name: External-secrets | Force sync secrets
  delegate_to: localhost
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ local_kubeconfig }}"
    api_version: external-secrets.io/v1beta1
    kind: ExternalSecret
    name: "{{ item }}"
    namespace: "{{ apps_zitadel.namespace }}"
    definition:
      metadata:
        annotations:
          force-sync: "{{ ansible_date_time.epoch }}"
  register: zitadel_resync
  loop:
    - zitadel-credentials
    - zitadel-masterkey

- name: Force restart zitadel application # noqa: no-handler
  when: zitadel_resync is changed
  delegate_to: "{{ inventory_hostname }}"
  vars:
    namespace: zitadel
    dep_name: zitadel
  ansible.builtin.shell: |
    kubectl rollout restart deployment --namespace '{{ namespace }}' \
    '{{ dep_name }}' && \
    kubectl rollout status deployment --namespace '{{ namespace }}' \
    '{{ dep_name }}'
  changed_when: false

- name: Authenticate console
  ansible.builtin.import_tasks: auth.yaml

- name: Configure Zitadel resources
  ansible.builtin.import_tasks: setup.yaml
