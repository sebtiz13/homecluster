- name: Retrieve cluster kubeconfig
  ansible.builtin.command: yq e '.contexts.0.context.namespace="{{ cluster_namespace }}"' {{ cluster_kubeconfig }}
  changed_when: false
  register: kubed_kubeconfig

- name: Store cluster kubeconfig
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Secret
    name: "{{ apps_kubed.secret_name }}"
    namespace: "{{ apps_kubed.namespace }}"
    definition:
      data:
        kubeconfig: "{{ kubed_kubeconfig.stdout | b64encode }}"

- name: Restart application resources for update secrets
  delegate_to: "{{ inventory_hostname }}"
  vars:
    kubed_manifest: "{{ lookup('file', manifests_folder + '/kubed.yaml') | from_yaml }}"
    cmd_args: "-n '{{ apps_kubed.namespace }}' 'deployment/{{ apps_kubed.release_name }}'"
  ansible.builtin.shell: >-
    kubectl rollout restart {{ cmd_args }} >/dev/null &&
    kubectl rollout status {{ cmd_args }} >/dev/null
  changed_when: false
