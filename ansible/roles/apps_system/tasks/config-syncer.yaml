- name: Config Syncer | Retrieve informations
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/config-syncer.yaml') | from_yaml }}"
    values: "{{ manifest.spec.source.helm['values'] | from_yaml }}"
  ansible.builtin.set_fact:
    apps_config_syncer:
      release_name: "{{ manifest.spec.source.helm.releaseName }}-kubed"
      namespace: "{{ manifest.spec.destination.namespace }}"
      secret_name: "{{ values['kubed'].config.existingSecret | default('') }}"

- name: Config Syncer | Wait until namespace is created
  when: apps_config_syncer.secret_name != ""
  kubernetes.core.k8s_info:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Namespace
    name: "{{ apps_config_syncer.namespace }}"
    wait: true
- name: Config Syncer | Create kubeconfig secret
  when: apps_config_syncer.secret_name != ""
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    template: cs_secret.yaml.j2
