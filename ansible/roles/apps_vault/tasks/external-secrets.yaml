- name: Configure kubernetes role for application
  vars:
    name: external-secrets
    existing_roles: "{{ (vault_k8s_role.data | default({})) | community.general.json_query('data.keys') }}"
  when: "('data' not in vault_k8s_role) or (name not in existing_roles)"
  community.hashi_vault.vault_write:
    url: "{{ ansible_hashi_vault_addr }}"
    validate_certs: false
    token: "{{ ansible_hashi_vault_token }}"
    path: "auth/kubernetes/role/{{ name }}"
    data:
      bound_service_account_names: "{{ apps_external_secrets.release_name }}"
      bound_service_account_namespaces: "{{ apps_external_secrets.namespace }}"
      policies: argocd
      ttl: 1h

- name: Configure cluster store for application
  vars:
    name: vault-argocd
    vault_url: "http://{{ apps_vault.release_name }}-internal.{{ apps_vault.namespace }}.svc:8200"
    vault_role_name: external-secrets
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig.dest }}"
    state: present
    namespace: "{{ apps_external_secrets.namespace }}"
    template: es_store.yaml.j2
