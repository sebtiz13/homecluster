- name: ArgoCD | Create policy
  delegate_to: "{{ inventory_hostname }}"
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/sys/policy/argocd"
    method: POST
    status_code: 204
    body_format: json
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      policy: "{{ lookup('ansible.builtin.file', './argocd.hcl') }}"

- name: ArgoCD | Configure kubernetes auth role for AVP
  delegate_to: "{{ inventory_hostname }}"
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/auth/kubernetes/role/argocd"
    method: POST
    status_code: 204
    body_format: json
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      bound_service_account_names: "argocd-repo-server"
      bound_service_account_namespaces: "{{ argocd_namespace }}"
      policies: argocd
      ttl: 1h
