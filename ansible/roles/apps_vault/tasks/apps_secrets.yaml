- name: Fill OVH credentials (prod)
  no_log: true
  when: env == 'production'
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/salamandre/data/cert-manager/ovh"
    method: POST
    status_code:
      - 204 # When successfull
      - 200 # When warning
    body_format: json
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      data:
        applicationKey: "{{ cert_manager_ovh_auth.application_key }}"
        applicationSecret: "{{ cert_manager_ovh_auth.application_secret }}"
        consumerKey: "{{ cert_manager_ovh_auth.consumer_key }}"

- name: Fill SMTP credentials
  no_log: true
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/salamandre/data/smtp"
    method: POST
    status_code:
      - 204 # When successfull
      - 200 # When warning
    body_format: json
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      data: "{{ smtp_auth }}"

- name: Fill backup informations
  no_log: true
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/salamandre/data/backup/s3"
    method: POST
    status_code:
      - 204 # When successfull
      - 200 # When warning
    body_format: json
    headers:
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      data:
        endpoint: "{{ external_urls.baku_minio }}"
        region: minio
        accessKey: salamandre-backup
        secretKey: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits'], length=40) }}"
        bucketPvc: backup-salamandre-pvc
