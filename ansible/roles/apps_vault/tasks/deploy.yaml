- name: Deploy application manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/vault.yaml"
    namespace: "{{ argocd_namespace }}"

- name: Retrieve server service
  kubernetes.core.k8s_info:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Service
    name: vault
    namespace: vault
    wait: true
  register: vault_server
- name: Store server url
  ansible.builtin.set_fact:
    vault_api_url: "http://{{ vault_server.resources.0.spec.clusterIP }}:{{ vault_server.resources.0.spec.ports.0.port }}/v1"

- name: Wait until application is available
  delegate_to: "{{ inventory_hostname }}"
  ansible.builtin.uri:
    url: "{{ vault_api_url }}/sys/health"
    method: GET
    status_code:
      - 501 # if not initialized
      - 503 # if sealed
      - 200 # if initialized, unsealed, and active
    return_content: true
  register: vault_health
  until: vault_health.status == 501 or vault_health.status == 503 or vault_health.status == 200
  retries: 60 # This is for wait max 10min (this is for support slow connection)
  delay: 10
