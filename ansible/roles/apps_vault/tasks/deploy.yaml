- name: Deploy application manifest
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/vault.yaml"
    namespace: "{{ argocd_namespace }}"

- name: Wait until application is available
  ansible.builtin.uri:
    url: "{{ ansible_hashi_vault_addr }}/v1/sys/health"
    validate_certs: false
    method: GET
    status_code:
      - 501 # if not initialized
      - 503 # if sealed
      - 200 # if initialized, unsealed, and active
    return_content: true
  register: vault_health
  until: vault_health.status == 501 or vault_health.status == 503 or vault_health.status == 200
  retries: 60 # This is for wait max 10min (this is for support slow connection)
  delay: 10
