- name: Nextcloud | Remove unused apps
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ local_kubeconfig }}"
    namespace: "{{ apps_nextcloud.namespace }}"
    pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
    command: su -m www-data -s /bin/sh -c 'php occ app:disable {{ item }}'
  loop: "{{ nextcloud_apps.disable }}"

- name: Nextcloud | Install wanted apps
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ local_kubeconfig }}"
    namespace: "{{ apps_nextcloud.namespace }}"
    pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
    command: su -m www-data -s /bin/sh -c 'php occ app:enable {{ item }}'
  loop: "{{ nextcloud_apps.enable }}"

- name: Nextcloud | Configure apps
  vars:
    base: "php occ config:app:set {{ item.id }} "
    commands:
      - id: preview
        commands:
          - jpeg_quality --value 60
      - id: admin_audit # Admin Audit
        commands:
          - logfile --value /var/www/html/data/audit.log
      - id: richdocuments # Collabora
        commands:
          - disable_certificate_verification --value yes
          - wopi_allowlist --value 10.42.0.0/16
          - wopi_url --value {{ apps_nextcloud.host }}
      - id: bookmarks # Bookmarks
        commands:
          - privacy.enableScraping --value true
      - id: drawio # Draw.io
        commands:
          - DrawioTheme --value dark
          - DrawioLibraries --value yes
      - id: external # External sites
        commands:
          - sites --value "{\"1\":{\"id\":1,\"name\":\"Wallabag\",\"url\":\"https:\/\/bag.{{ domain_name }}\",\"lang\":\"\",\"type\":\"link\",\"device\":\"\",\"icon\":\"wallabag.svg\",\"groups\":[],\"redirect\":false}}"
          - max_site --value 1
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ local_kubeconfig }}"
    namespace: "{{ apps_nextcloud.namespace }}"
    pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
    command: su -m www-data -s /bin/sh -c '{{ base }}{{ item.commands | join(' && ' + base) }}'
  loop: "{{ commands }}"
  loop_control:
    label: "{{ item.id }}"

- name: Nextcloud | Retrieve instance id
  kubernetes.core.k8s_exec:
    kubeconfig: "{{ local_kubeconfig }}"
    namespace: "{{ apps_nextcloud.namespace }}"
    pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
    command: su -m www-data -s /bin/sh -c 'php occ config:system:get instanceid'
  register: nextcloud_instanceid

- name: Nextcloud | Upload external apps icons
  vars:
    base_path: /var/www/html/data/appdata_{{ nextcloud_instanceid.stdout_lines.0 }}/external/icons
    icons:
      - wallabag.svg
      - wallabag-dark.svg
  block:
    - name: Nextcloud | Upload external apps icons
      kubernetes.core.k8s_cp:
        kubeconfig: "{{ local_kubeconfig }}"
        state: to_pod
        namespace: "{{ apps_nextcloud.namespace }}"
        pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
        container: nextcloud
        local_path: "{{ item }}"
        remote_path: "{{ base_path }}/{{ item }}"
        no_preserve: true
      loop: "{{ icons }}"

    - name: Nextcloud | Fix permission of external apps icons
      kubernetes.core.k8s_exec:
        kubeconfig: "{{ local_kubeconfig }}"
        namespace: "{{ apps_nextcloud.namespace }}"
        pod: "{{ (nextcloud_pod.resources | first).metadata.name }}"
        command: chown www-data:www-data {{ base_path }}/{{ item }}
      loop: "{{ icons }}"
