- name: Nextcloud | Retrieve application informations
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/nextcloud.yaml') | from_yaml }}"
    host: "https://{{ manifest.metadata.annotations['sebtiz13.fr/host'] }}"
  ansible.builtin.set_fact:
    apps_nextcloud:
      _manifest: "{{ manifest }}"
      _db_passowrd: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits']) }}"
      release_name: "{{ manifest.spec.source.plugin.env.0.value }}"
      namespace: "{{ manifest.spec.destination.namespace }}"
      host: "{{ host }}"

- name: Nextcloud | Create database access # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: database_access
  vars:
    database: nextcloud
    username: nextcloud
    password: "{{ apps_nextcloud._db_passowrd }}"

- name: Nextcloud | Check if is already deploy
  kubernetes.core.k8s_info:
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Service
    name: "{{ apps_nextcloud.release_name }}"
    namespace: "{{ apps_nextcloud.namespace }}"
  register: nextcloud_server

- name: Nextcloud | Deploy application and secrets # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: argocd_app
  vars:
    manifest: "{{ apps_nextcloud._manifest }}"
    restart_resources:
      - kind: Deployment
        name: "{{ apps_nextcloud.release_name }}"
    wait_resources:
      - kind: Deployment
        name: "{{ apps_nextcloud.release_name }}"
    secrets:
      - path: nextcloud/auth
        data:
          adminUser: admin
          adminPassword: "{{ admin_passwords.nextcloud }}"
          collaboraAdminUser: admin
          collaboraAdminPassword: "{{ admin_passwords.collabora }}"
      - path: nextcloud/database
        data:
          host: postgresql.loc
          port: "5432"
          database: nextcloud
          user: nextcloud
          password: "{{ apps_nextcloud._db_passowrd }}"
