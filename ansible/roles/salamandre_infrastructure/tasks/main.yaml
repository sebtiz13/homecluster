- name: Deploy Minio
  tags: minio
  ansible.builtin.import_tasks: minio.yaml

- name: Deploy Gitlab
  tags:
    - minio # Depends on s3
    - oidc # Require OIDC
    - gitlab
  ansible.builtin.import_tasks: gitlab.yaml

- name: Deploy Adguard proxy application manifest
  tags: adguard
  when: env == 'prod'
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/adguard-proxy.yaml"
    namespace: "{{ argocd_namespace }}"

- name: Deploy monitoring stack
  when: "(ansible_limit is not defined) or ('baku' in ansible_limit)"
  tags: monitoring
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    src: "{{ manifests_folder }}/monitoring.yaml"
    namespace: "{{ argocd_namespace }}"
