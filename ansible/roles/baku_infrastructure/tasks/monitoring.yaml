- name: Retrieve Monitoring & Grafana informations
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/monitoring.yaml') | from_yaml }}"
  ansible.builtin.set_fact:
    apps_monitoring:
      _manifest: "{{ manifest }}"
      _vms_passowrd: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits']) }}"
      release_name: "{{ manifest.spec.source.plugin.env.0.value }}"
      namespace: "{{ manifest.spec.destination.namespace }}"
      host: "https://{{ manifest.metadata.annotations['sebtiz13.fr/host'] }}"

- name: Create Grafana OIDC access # noqa: var-naming[no-role-prefix]
  tags: oidc
  ansible.builtin.include_role:
    name: oidc_access
  vars:
    secret_path: grafana/oidc
    project_id: "{{ hostvars.salamandre.zitadel_dev_project_id }}"
    app_name: Grafana
    redirect_uris:
      - "{{ apps_monitoring.host }}/login/generic_oauth"
    post_logout_redirect_uris:
      - "{{ apps_monitoring.host }}/login"
    response_types:
      - OIDC_RESPONSE_TYPE_CODE
    grant_types:
      - OIDC_GRANT_TYPE_AUTHORIZATION_CODE
      - OIDC_GRANT_TYPE_REFRESH_TOKEN
    auth_method_type: OIDC_AUTH_METHOD_TYPE_BASIC

- name: Deploy Monitoring & Grafana application and secrets # noqa: var-naming[no-role-prefix]
  ansible.builtin.include_role:
    name: argocd_vault
  vars:
    manifest: "{{ apps_monitoring._manifest }}"
    restart_resources:
      - kind: Deployment
        name: "{{ apps_monitoring.release_name }}-grafana"
    secrets:
      - path: monitoring/auth
        data:
          vmsingleUser: vmsingle
          vmsinglePassword: "{{ apps_monitoring._vms_passowrd }}"
      - path: monitoring/alertmanager
        data:
          discord: "{{ monitoring.alertmanager.discord.webhook_url }}"
      - path: grafana/auth
        data:
          adminUser: admin
          adminPassword: "{{ admin_passwords.grafana }}"

- name: Create VictoriaMetrics auth # noqa: var-naming[no-role-prefix]
  tags: traefik
  ansible.builtin.include_role:
    name: traefik_auth
  vars:
    namespace: traefik
    middleware_name: auth-vm
    secret_name: "{{ apps_monitoring.release_name }}-vm-users"
    users:
      - name: vmsingle
        password: "{{ apps_monitoring._vms_passowrd }}"
