- name: Retrieve application informations
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/external-secrets.yaml') | from_yaml }}"
  ansible.builtin.set_fact:
    apps_external_secrets:
      release_name: '{{ manifest.spec.source.helm.releaseName }}'
      namespace: '{{ manifest.spec.destination.namespace }}'

- name: Deploy application manifest
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig.dest }}'
    state: present
    src: '{{ manifests_folder }}/external-secrets.yaml'
    namespace: '{{ apps_argocd.namespace }}'

- name: Wait until application is available
  kubernetes.core.k8s_info:
    kubeconfig: '{{ kubeconfig.dest }}'
    kind: Deployment
    name: '{{ apps_external_secrets.release_name }}-webhook'
    namespace: '{{ apps_external_secrets.namespace }}'
    wait: true
    wait_sleep: 10
    wait_timeout: 360
