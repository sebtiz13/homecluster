- name: Write smtp secrets
  vars:
    path: smtp
    data: '{{ smtp_auth }}'
    full_path: '{{ secrets_base_path }}/{{ path }}'
  # no_log: true
  block:
    - name: Retrieve current stored secret
      vars:
        not_found_msg: "The path '{{ full_path }}' doesn't seem to exist."
      community.hashi_vault.vault_read:
        url: '{{ ansible_hashi_vault_addr }}'
        token: '{{ ansible_hashi_vault_token }}'
        path: '{{ full_path }}'
      failed_when:
        - "'msg' in vault_check and vault_check.msg != not_found_msg"
      register: vault_check

    - name: Write new secret
      when: ('msg' in vault_check) or (vault_check.data.data.data != data)
      community.hashi_vault.vault_write:
        url: '{{ ansible_hashi_vault_addr }}'
        token: '{{ ansible_hashi_vault_token }}'
        path: '{{ full_path }}'
        data:
          data: '{{ data }}'
