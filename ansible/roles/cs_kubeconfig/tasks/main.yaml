- name: Retrieve application informations
  vars:
    manifest: "{{ lookup('file', manifests_folder + '/config-syncer.yaml') | from_yaml }}"
    values: "{{ manifest.spec.source.helm['values'] | from_yaml }}"
  ansible.builtin.set_fact:
    apps_config_syncer:
      release_name: "{{ manifest.spec.source.helm.releaseName }}"
      namespace: "{{ manifest.spec.destination.namespace }}"
      secret_name: "{{ values['kubed'].config.existingSecret }}"

- name: Create application namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    resource_definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ apps_config_syncer.namespace }}"

- name: Create application config secret
  kubernetes.core.k8s:
    kubeconfig: "{{ local_kubeconfig }}"
    state: present
    template: secret.yaml.j2
