- name: Retrieve cluster kubeconfig
  ansible.builtin.command: yq e '.contexts.0.context.namespace="{{ cluster_namespace }}"' {{ cluster_kubeconfig }}
  changed_when: false
  register: cs_kubeconfig

- name: Store cluster kubeconfig
  kubernetes.core.k8s:
    state: patched
    kubeconfig: "{{ local_kubeconfig }}"
    kind: Secret
    name: "{{ apps_config_syncer.secret_name }}"
    namespace: "{{ apps_config_syncer.namespace }}"
    definition:
      data:
        kubeconfig: "{{ cs_kubeconfig.stdout | b64encode }}"

- name: Restart application resources for update secrets
  delegate_to: "{{ inventory_hostname }}"
  vars:
    cmd_args: "-n '{{ apps_config_syncer.namespace }}' 'deployment/{{ apps_config_syncer.release_name }}'"
  ansible.builtin.shell: >-
    kubectl rollout restart {{ cmd_args }} >/dev/null &&
    kubectl rollout status {{ cmd_args }} >/dev/null
  changed_when: false
