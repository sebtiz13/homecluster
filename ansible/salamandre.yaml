- name: Install sensors, database, configure coreDNS
  hosts: salamandre
  roles:
    - role: salamandre_sensors
      when: motherboard_chip is defined
      connection: ssh
      become: true
      tags: sensors
    - role: database
      connection: ssh
      become: true
      tags: database
    - role: coredns
      delegate_to: localhost
      tags: kubernetes

- name: Install prerequired applications
  hosts: salamandre
  tags: kubernetes
  roles:
    - role: apps_argocd
      delegate_to: localhost
      tags: argocd
    - role: kubed_kubeconfig
      delegate_to: localhost
      tags: kubed
    - role: apps_system
      delegate_to: localhost
      tags: common
    - role: apps_external-secrets
      delegate_to: localhost
      tags: external-secret
    - role: apps_vault
      delegate_to: localhost
      tags: vault

- name: Install cert-manager, dev apps, configure smtp auth and create traefik auth
  hosts: salamandre
  tags: kubernetes
  pre_tasks:
    - name: Store ArgoCD api token in facts
      ansible.builtin.set_fact:
        argocd_api_token: "{{ argocd_admin_auth.json.token }}"
  roles:
    - role: traefik_auth
      delegate_to: localhost
      tags: traefik
      vars:
        namespace: traefik # noqa: var-naming[no-role-prefix]
        middleware_name: admin-auth # noqa: var-naming[no-role-prefix]
        secret_name: admin-users # noqa: var-naming[no-role-prefix]
        users: "{{ basic_auth_users }}" # noqa: var-naming[no-role-prefix]
    - role: apps_cert-manager
      delegate_to: localhost
      tags:
        - cert-manager
        - tls
    - role: vault_secrets
      delegate_to: localhost
      tags: smtp
      vars:
        validate_certs: false # noqa: var-naming[no-role-prefix]
        secrets: # noqa: var-naming[no-role-prefix]
          - path: smtp
            data: "{{ smtp_auth }}"
    - role: salamandre_dev
      delegate_to: localhost
      when: env == 'dev'
  post_tasks:
    - name: Wait until tls certificate created in vault
      delegate_to: localhost
      tags:
        - vault
        - cert-manager
        - tls
      kubernetes.core.k8s_info:
        kubeconfig: "{{ local_kubeconfig }}"
        kind: Secret
        name: "{{ root_domain | replace('.', '-') }}-tls"
        namespace: "{{ apps_vault.namespace }}"
        wait: true
        wait_sleep: 10
        wait_timeout: 360

- name: Install, configure OIDC and sync ArgoCD
  hosts: salamandre
  tags: kubernetes
  roles:
    - role: oidc
      delegate_to: localhost
      tags: oidc
    - name: Fake Grafana and argoCD OIDC
      role: vault_secrets
      when: "'oidc' in ansible_skip_tags"
      delegate_to: localhost
      vars:
        secrets: # noqa: var-naming[no-role-prefix]
          - path: argocd/oidc
            data:
              issuer: "http://localhost"
              clientID: "fake"
              clientSecret: "fake"
          - path: grafana/oidc
            data:
              issuer: "http://localhost"
              clientID: "fake"
              clientSecret: "fake"

    - role: argocd_sync
      delegate_to: localhost
      tags: argocd

- name: Install infrastructure applications
  hosts: salamandre
  tags: kubernetes
  roles:
    - role: salamandre_infrastructure
      delegate_to: localhost

- name: Install cloud applications
  hosts: salamandre
  tags:
    - kubernetes
    - cloud
  roles:
    - role: salamandre_cloud
      delegate_to: localhost
