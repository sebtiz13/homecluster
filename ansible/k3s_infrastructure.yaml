- name: Initialize variables
  hosts: all
  tags: kubernetes
  tasks:
    - name: Load applications admin passwords # TODO: use ansible vault ?
      ansible.builtin.include_vars:
        file: "{{ credentials_folder }}/admin_passwords.yaml"
        name: admin_passwords

- name: Deploy dev and infrastructure applications
  hosts: salamandre
  tags: kubernetes
  pre_tasks:
    - name: Create vault access
      delegate_to: localhost
      ansible.builtin.import_tasks: tasks/s_vault_access.yaml
  roles:
    - role: salamandre_dev
      delegate_to: localhost
      when: env == 'dev'
    - role: oidc
      delegate_to: localhost
      tags: oidc
    - role: salamandre_infrastructure
      delegate_to: localhost

- name: Install infrastructure applications
  hosts: baku
  tags: kubernetes
  roles:
    - role: baku_infrastructure
      delegate_to: localhost

- name: Finish monitoring setup
  hosts: salamandre
  tags: kubernetes
  tasks:
    - name: Monitoring | Create credentials secret
      delegate_to: localhost
      kubernetes.core.k8s:
        state: patched
        kubeconfig: "{{ local_kubeconfig }}"
        api_version: external-secrets.io/v1beta1
        kind: ExternalSecret
        name: vm-stack-credentials
        namespace: monitoring
        definition:
          metadata:
            annotations:
              force-sync: "{{ ansible_date_time.epoch }}"
