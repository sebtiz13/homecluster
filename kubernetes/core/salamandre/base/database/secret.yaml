apiVersion: generators.external-secrets.io/v1alpha1
kind: Password
metadata:
  name: cnpg-super-password
spec:
  length: 16
  symbols: 0
  noUpper: false
  allowRepeat: true
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cnpg-secret
spec:
  secretStoreRef:
    name: vault-eso
    kind: ClusterSecretStore
  target:
    template:
      type: Opaque
      metadata:
        labels:
          cnpg.io/reload: "true"
      data:
        POSTGRES_SUPER_USER: cloudnative-pg-super
        POSTGRES_SUPER_PASS: "{{ .password }}"
        S3_ACCESS_KEY: "{{ .accessKey }}"
        S3_SECRET_KEY: "{{ .secretKey }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: "cnpg-super-password"
    - extract:
        key: salamandre/data/backup/s3
---
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: cnpg-secret
spec:
  secretStoreRefs:
    - name: vault-eso
      kind: ClusterSecretStore
  selector:
    secret:
      name: cnpg-secret
  data:
    - match:
        secretKey: POSTGRES_SUPER_USER
        remoteRef:
          remoteKey: "salamandre/data/db-init"
          property: superUser
    - match:
        secretKey: POSTGRES_SUPER_PASS
        remoteRef:
          remoteKey: "salamandre/data/db-init"
          property: superPass
