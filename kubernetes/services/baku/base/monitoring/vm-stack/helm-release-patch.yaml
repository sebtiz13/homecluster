apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
spec:
  values:
    vmsingle:
      ingress:
        enabled: true
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: monitoring-vm-auth@kubernetescrd
          traefik.ingress.kubernetes.io/router.entrypoints: monitoring
        hosts:
          - &host monitor.${DOMAIN_NAME}
        tls:
          - hosts:
              - *host
      spec:
        retentionPeriod: "14" # 14 months
        storage:
          storageClassName: openebs-zfspv
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 50Gi

    vmagent:
      spec:
        externalLabels:
          cluster: baku

    alertmanager:
      useManagedConfig: true
      config:
        inhibit_rules:
          - target_matchers:
              - severity="info"
            source_matchers:
              - alertname=InfoInhibitor
        route:
          receiver: discord
          routes:
            - matchers:
                - alertname=InfoInhibitor
              receiver: blackhole
        receivers:
          - name: blackhole
          - name: discord
            discord_configs:
              - webhook_url: "${ALERTS_DISCORD_WEBHOOK_URL}"
                title: '{{ template "homecluster.discord.title" . }}'
                message: '{{ template "homecluster.discord.message" . }}'
      monzoTemplate:
        enabled: false

    # Disable tweaked alert rules
    defaultRules:
      rules:
        kubeApiserverAvailability: false # For k3s change
        kubeApiserverBurnrate: false # For k3s change
        kubeApiserverHistogram: false # For k3s change
        kubeScheduler: false # For k3s change
        kubernetesSystem: false # For k3s change
        vmagent: false # remove dashboard annotation
