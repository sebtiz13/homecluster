plugin: argocd-vault-plugin-helm

ingress:
  subdomain: monitor
  port: 53639

source:
  repoURL: https://gitlab.com/api/v4/projects/40446088/packages/helm/stable
  chart: monitoring
  targetRevision: 1.0.1

destination:
  namespace: monitoring

syncPolicy:
  createLabeledNamespace: true
  automated:
    prune: true
    selfHeal: true

alertmanager:
  discordTemplate: |-
    {{- define "homecluster.discord.title" }}
    {{- if .CommonLabels.cluster }}[{{ .CommonLabels.cluster }}] {{ end -}}
    {{- if gt (len .Alerts.Firing) 0 -}}
    Fire {{ .Alerts.Firing | len }} alerts
    {{- if gt (len .Alerts.Resolved) 0 }} and {{ end -}}
    {{- end -}}
    {{- if gt (len .Alerts.Resolved) 0 -}}
    {{- .Alerts.Resolved | len }} alerts resolved
    {{- end -}}
    {{- if .CommonLabels.job }} for {{ .CommonLabels.job }}{{ end }} !
    {{- end }}

    {{- define "homecluster.discord.message" }}
    {{- $alerts := 0 -}}
    {{- if gt (len .Alerts.Firing) 0 -}}
    {{- $alerts = .Alerts.Firing -}}
    {{- else -}}
    {{- $alerts = .Alerts.Resolved -}}
    {{- end -}}
    {{- range $alerts }}
    - Alert: {{ if .Labels.cluster }}[{{ .Labels.cluster }}] {{ end -}}
        **{{ if gt (len .Annotations.summary) 150 -}}
        {{- printf "%.150s..." .Annotations.summary -}}
        {{- else -}}
        {{- .Annotations.summary -}}
        {{- end }}**
        {{- if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
      Description:
      > {{ if gt (len .Annotations.description) 150 -}}
        {{- printf "%.150s..." .Annotations.description | reReplaceAll "\\n" "\\n  > " }}
        {{- else -}}
        {{- .Annotations.description | reReplaceAll "\\n" "\\n  > " }}
        {{- end }}
      Labels:
      > {{ range .Labels.SortedPairs }}
        {{- printf "`%s=%s`  " .Name .Value }}
        {{- end }}
    {{- end }}

    {{ if and (gt (len .Alerts.Firing) 0) (gt (len .Alerts.Resolved) 0) }}
    > Also {{ .Alerts.Resolved | len }} resolved alerts.
    {{- end }}
    {{- end }}

grafana:
  dashboardsReleaseBranch: main
  dashboards:
    kubernetes:
      views_global: true
      views_namespaces: true
      views_pods: true
      volumes_cluster: true
    victoriametrics:
      global: true
      vmagent: true
      vmalert: true
    default:
      minio: true
      nodeexporter: true
      traefik: true
