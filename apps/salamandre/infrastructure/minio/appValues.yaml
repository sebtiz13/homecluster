{{- define "svcacct.policy" }}
Version: "2012-10-17"
Statement:
  - Effect: Allow
    Action:
      - s3:ListBucket
      - s3:GetObject
      - s3:DeleteObject
      - s3:PutObject
    Resource:
      {{- range . }}
      - {{ printf "arn:aws:s3:::%s" . | quote }}
     {{ end -}}
{{- end -}}
{{- define "svcacct.command" }}
{{ $rootUser := "<path:salamandre/data/minio/auth#rootUser>" }}
{{ $policy := printf "$(echo '%s' > policy.json && echo \"policy.json\")" (include "svcacct.policy" .resources | fromYaml | toJson) }}
{{- printf "admin user svcacct add --access-key \"%s\" --secret-key \"%s\" --policy \"%s\" myminio \"%s\"" .accessKey .secretKey $policy $rootUser }}
{{- end -}}

fullnameOverride: "minio"

rootUser: <path:salamandre/data/minio/auth#rootUser>
rootPassword: <path:salamandre/data/minio/auth#rootPassword>
mode: standalone

buckets:
  - name: tmp
    policy: none
  {{- range .Values.buckets }}
  - name: {{ .name }}
    policy: {{ .policy }}
  {{- end }}

customCommands:
  {{- range .Values.serviceAccounts }}
  - command: {{ include "svcacct.command" . | trim | quote }}
  {{- end }}

environment:
  MINIO_BROWSER_REDIRECT_URL: https://console.s3.{{ .Values.baseDomain }}
ingress:
  enabled: true
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  path: /
  hosts:
    - s3.{{ .Values.baseDomain }}
  tls:
    - secretName: {{ include "ingress.tls.secretName" . }}
      hosts:
        - s3.{{ .Values.baseDomain }}
consoleIngress:
  enabled: true
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  hosts:
    - console.s3.{{ .Values.baseDomain }}
  tls:
    - secretName: {{ include "ingress.tls.secretName" . }}
      hosts:
        - console.s3.{{ .Values.baseDomain }}

persistence:
  size: 10Gi

resources:
  requests:
      cpu: 10m
      memory: 192Mi
  limits:
      cpu: 1000m
      memory: 1Gi
