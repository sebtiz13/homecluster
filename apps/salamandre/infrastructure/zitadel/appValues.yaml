zitadel:
  image:
    tag: v2.42.3

  ingress:
    enabled: true
    className: traefik
    annotations:
      {{ include "ingress.annotations.httpsRedirect" . | nindent 6 }}
    hosts:
      - host: {{ include "ingress.host" . }}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: {{ include "ingress.tls.secretName" . }}
        hosts:
          - {{ include "ingress.host" . }}
  service:
    annotations:
      traefik.ingress.kubernetes.io/service.serversscheme: h2c

  env:
    - name: TZ
      value: Europe/Paris

  zitadel:
    masterkeySecretName: zitadel-masterkey
    configSecretName: zitadel-credentials
    configSecretKey: config-yaml

    configmapConfig:
      ExternalSecure: true
      ExternalDomain: {{ include "ingress.host" . }}
      ExternalPort: 443
      TLS:
        Enabled: false
      Database:
        Postgres:
          MaxOpenConns: 20
          MaxIdleConns: 10
          MaxConnLifetime: 30m
          MaxConnIdleTime: 5m
          User:
            SSL:
              Mode: disable
      FirstInstance:
        Org:
          Machine:
            Machine:
              Username: zitadel-admin-sa
              Name: Admin
            MachineKey:
              Type: 1
      DefaultInstance:
        SMTPConfiguration:
          FromName: Zitadel
        LoginPolicy:
          AllowRegister: false
        LabelPolicy:
          PrimaryColor: "#8FBCBB"
          BackgroundColor: "#D8DEE9"
          WarnColor: "#BF616A"
          FontColor: "#2E3440"
          PrimaryColorDark: "#8FBCBB"
          BackgroundColorDark: "#2E3440"
          WarnColorDark: "#BF616A"
          FontColorDark: "#ECEFF4"
          HideLoginNameSuffix: true
          ErrorMsgPopup: true
          DisableWatermark: true

external-secrets:
  secrets:
    - name: masterkey
      annotations:
        helm.sh/hook: pre-install,pre-upgrade
        helm.sh/hook-delete-policy: before-hook-creation
        helm.sh/hook-weight: "0"
      dataFrom:
        - extract:
            key: salamandre/zitadel/masterkey
          rewrite:
            - regexp:
                source: "value"
                target: "masterkey"
    - name: credentials
      annotations:
        helm.sh/hook: pre-install,pre-upgrade
        helm.sh/hook-delete-policy: before-hook-creation
        helm.sh/hook-weight: "0"
      target:
        template:
          type: Opaque
          data:
            config-yaml: |-
              {{`Database:
                Postgres:
                  Host: {{ .db_host }}
                  Port: {{ .db_port }}
                  Database: {{ .db_database }}
                  User:
                    Username: {{ .db_user }}
                    Password: {{ .db_password }}
              DefaultInstance:
                SMTPConfiguration:
                  SMTP:
                    Host: "{{ .smtp_host }}:{{ .smtp_port }}"
                    User: {{ .smtp_username }}
                    Password: {{ .smtp_password }}
                  From: {{ .smtp_username }}`}}
      dataFrom:
        - extract:
            key: salamandre/zitadel/database
          rewrite:
            - regexp:
                source: "(.*)"
                target: "db_$1"
        - extract:
            key: salamandre/smtp
          rewrite:
            - regexp:
                source: "(.*)"
                target: "smtp_$1"
