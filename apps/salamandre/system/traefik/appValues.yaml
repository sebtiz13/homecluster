priorityClassName: system-cluster-critical

ingressClass:
  enabled: true
  isDefaultClass: true

providers:
  kubernetesIngress:
    publishedService:
      enabled: true

env:
  - name: TZ
    value: Europe/Paris

metrics:
  prometheus:
    service:
      enabled: true
    serviceMonitor:
      enabled: true
      jobLabel: traefik
      honorLabels: true

{{- $domainName := .Values.baseDomain | replace "." "-" }}
{{- $tlsSecretName := printf "%s-tls" $domainName }}
extraObjects:
  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: redirect-https
    spec:
      redirectScheme:
        scheme: https
        permanent: true
  - apiVersion: traefik.io/v1alpha1
    kind: TLSStore
    metadata:
      name: default
    spec:
      defaultCertificate:
        secretName: {{ $tlsSecretName }}
  - apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: {{ $domainName }}
    spec:
      secretName: {{ $tlsSecretName }}
      issuerRef:
        name: {{ $domainName }}-issuer
        kind: ClusterIssuer
      dnsNames:
        - "{{ .Values.baseDomain }}"
        - "*.{{ .Values.baseDomain }}"
        - "console.s3.{{ .Values.baseDomain }}"
  - apiVersion: external-secrets.io/v1alpha1
    kind: PushSecret
    metadata:
      name: {{ $tlsSecretName }}
    spec:
      secretStoreRefs:
        - name: vault-eso
          kind: ClusterSecretStore
      selector:
        secret:
          name: {{ $tlsSecretName }}
      data:
        - match:
            secretKey: tls.crt
            remoteRef:
              remoteKey: "salamandre/data/tls/{{ $domainName }}"
              property: crt
        - match:
            secretKey: tls.key
            remoteRef:
              remoteKey: "salamandre/data/tls/{{ $domainName }}"
              property: key
