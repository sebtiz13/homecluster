nextcloud:
  ingress:
    tls:
      - secretName: {{ include "ingress.tls.secretName" . }}
        hosts:
          - {{ include "ingress.host" . }}

  nextcloud:
    host: {{ include "ingress.host" . }}
    username: <path:salamandre/data/nextcloud/auth#adminUser>
    password: <path:salamandre/data/nextcloud/auth#adminPassword>

    configs:
      custom.config.php: |-
        <?php
        $$CONFIG = array (
          'default_phone_region' => 'FR'
        );

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1500m
      memory: 2Gi

  externalDatabase:
    enabled: true
    type: postgresql
    host: <path:salamandre/data/nextcloud/database#host>:<path:salamandre/data/nextcloud/database#port>
    database: <path:salamandre/data/nextcloud/database#database>
    user: <path:salamandre/data/nextcloud/database#user>
    password: <path:salamandre/data/nextcloud/database#password>

  persistence:
    enabled: true
    nextcloudData:
      enabled: true
      size: 50Gi

  configCommands:
    # Set preview jpeg quality
    - php occ config:app:set preview jpeg_quality --value 60
    {{- if .Values.apps.admin_audit }}
    # Configure admin audit
    - php occ app:enable admin_audit && php occ config:app:set admin_audit logfile --value /var/www/html/data/audit.log
    {{- end }}
    {{- if .Values.collabora.enabled }}
    # Configure collabora
    - php occ app:enable richdocuments && php occ config:app:set richdocuments wopi_url --value https://{{ include "ingress.host" . }}
    {{- end }}

  metrics:
    # fix token (prevent diff on ArgoCD)
    token: nextcloud-token

collabora-code:
  enabled: {{ .Values.collabora.enabled }}

  collabora:
    aliasgroups:
      - domain: https://{{ include "ingress.host" . }}
    server_name: {{ include "ingress.host" . }}

    dictionaries: {{ .Values.collabora.dictionaries }}

    username: <path:salamandre/data/nextcloud/auth#collaboraAdminUser>
    password: <path:salamandre/data/nextcloud/auth#collaboraAdminPassword>
