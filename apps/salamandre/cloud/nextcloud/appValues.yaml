nextcloud:
  ingress:
    annotations:
      {{/* include "ingress.annotations.httpsRedirect" . | nindent 6 */}}
      traefik.ingress.kubernetes.io/router.middlewares: traefik-redirect-https@kubernetescrd,nextcloud-chained-middlewares@kubernetescrd
      traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    tls:
      - hosts:
          - {{ include "ingress.host" . }}

  nextcloud:
    host: {{ include "ingress.host" . }}

    existingSecret:
      enabled: true
      secretName: nextcloud-credentials

    configs:
      custom.config.php: |-
        <?php
        $$CONFIG = array (
          'default_phone_region' => 'FR',
          'forwarded_for_headers' => ['HTTP_X_FORWARDED_FOR']
        );

    mail:
      enabled: true
      fromAddress: contact
      domain: {{ .Values.baseDomain }}

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1500m
      memory: 2Gi

  externalDatabase:
    enabled: true
    type: postgresql
    existingSecret:
      enabled: true
      secretName: nextcloud-db-credentials
      hostKey: db-host
      databaseKey: db-name

  persistence:
    enabled: true
    nextcloudData:
      enabled: true
      storageClass: openebs-zfspv
      size: 500Gi

collabora-code:
  collabora:
    aliasgroups:
      - domain: https://{{ include "ingress.host" . }}
    server_name: {{ include "ingress.host" . }}

    dictionaries: en_GB en_US fr_FR

    existingSecret:
      enabled: true
      secretName: nextcloud-collabora-credentials

external-secrets:
  secrets:
    - name: credentials
      target:
        template:
          type: Opaque
          data:
            nextcloud-username: '{{`{{ .auth_adminUser }}`}}'
            nextcloud-password: '{{`{{ .auth_adminPassword }}`}}'
            smtp-host: '{{`{{ .smtp_host }}`}}'
            {{- if eq .Values.environment "prod" }}
            smtp-username: '{{`{{ .smtp_username }}`}}'
            smtp-password: '{{`{{ .smtp_password }}`}}'
            {{- else }}
            smtp-username: ''
            smtp-password: ''
            {{- end }}
      dataFrom:
        - extract:
            key: salamandre/nextcloud/auth
          rewrite:
            - regexp:
                source: "(.*)"
                target: "auth_$1"
        - extract:
            key: salamandre/smtp
          rewrite:
            - regexp:
                source: "(.*)"
                target: "smtp_$1"
    - name: db-credentials
      target:
        template:
          type: Opaque
          data:
            db-host: '{{`{{ .host }}:{{ .port }}`}}'
            db-username: '{{`{{ .user }}`}}'
            db-password: '{{`{{ .password }}`}}'
            db-name: '{{`{{ .database }}`}}'
      dataFrom:
        - extract:
            key: salamandre/nextcloud/database
    - name: collabora-credentials
      target:
        template:
          type: Opaque
          data:
            username: '{{`{{ .collaboraAdminUser }}`}}'
            password: '{{`{{ .collaboraAdminPassword }}`}}'
      dataFrom:
        - extract:
            key: salamandre/nextcloud/auth
