apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vault
  namespace: argocd
spec:
  project: cluster-core-apps
  source:
    repoURL: https://helm.releases.hashicorp.com
    chart: vault
    targetRevision: 0.22.0
    helm:
      values: |
        fullnameOverride: "vault"

        injector:
          enabled: false

        server:
          priorityClassName: system-cluster-critical

          ingress:
            enabled: true
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
            hosts:
              - host: ${url}
            tls:
              - secretName: ${tls_secret_name}
                hosts:
                  - ${url}

          # Configure readiness probe to report "ready" even if Vault is uninitialized and sealed.
          # Useful when bootstrapping Vault for the first time.
          readinessProbe:
            path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"

          postStart:
            - /bin/sh
            - -c
            - "sleep 5 && if [ -f \"/vault/keys/key1\" ]; then vault operator unseal $(cat /vault/keys/key1); fi"

          volumes:
            - name: vault-keys
              secret:
                secretName: vault-keys
                defaultMode: 0400
                optional: true
            - name: certificate
              secret:
                secretName: vm-ca-tls-secret
                defaultMode: 420
          volumeMounts:
            - mountPath: /vault/keys
              name: vault-keys
              readOnly: true
            - name: certificate
              mountPath: /etc/ssl/certs/ca.crt
              subPath: tls.crt

        ui:
          enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: vault
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
