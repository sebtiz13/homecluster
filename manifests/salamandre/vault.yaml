---
# Source: common-app/templates/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: salamandre-vault
  labels:
    helm.sh/chart: common-app-0.0.1
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    sebtiz13.fr/host: vault-secrets.sebtiz13.fr
spec:
  project: infrastructure
  source:
    repoURL: https://helm.releases.hashicorp.com
    chart: vault
    targetRevision: 0.23.0
    helm:
      releaseName: vault
      values: |
        injector:
          enabled: false
        server:
          ingress:
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
            enabled: true
            hosts:
            - host: vault-secrets.sebtiz13.fr
            tls:
            - hosts:
              - vault-secrets.sebtiz13.fr
              secretName: sebtiz13-fr-tls
          postStart:
          - /bin/sh
          - -c
          - sleep 5 && if [ -f "/vault/keys/key1" ]; then vault operator unseal $(cat /vault/keys/key1);
            fi
          readinessProbe:
            path: /v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204
          volumeMounts:
          - mountPath: /vault/keys
            name: vault-keys
            readOnly: true
          volumes:
          - name: vault-keys
            secret:
              defaultMode: 256
              optional: true
              secretName: vault-keys
        ui:
          enabled: true
  destination:
    name: in-cluster
    namespace: vault
  syncPolicy:
    automated: 
      prune: true
      selfHeal: true
