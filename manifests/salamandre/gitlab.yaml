---
# Source: common-app/templates/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: salamandre-gitlab
  labels:
    helm.sh/chart: common-app-0.0.1
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    sebtiz13.fr/host: git.sebtiz13.fr
spec:
  project: infrastructure
  source:
    repoURL: https://gitlab.com/api/v4/projects/40446088/packages/helm/stable
    chart: gitlab
    targetRevision: 1.0.1
    plugin:
      env:
        - name: HELM_RELEASE_NAME
          value: gitlab
        - name: HELM_VALUES
          value: |
            externalSecrets:
              secrets:
              - dataFrom:
                - extract:
                    key: salamandre/gitlab/database
                - extract:
                    key: salamandre/smtp
                  rewrite:
                  - regexp:
                      source: password
                      target: smtp_password
                name: credentials
                target:
                  template:
                    data:
                      postgresql-password: '{{ .password }}'
                      smtp-password: '{{ .smtp_password }}'
                    type: Opaque
              - dataFrom:
                - extract:
                    key: salamandre/gitlab/s3
                name: storage
                target:
                  template:
                    data:
                      accesskey: '{{ .accesskey }}'
                      connection: |-
                        provider: AWS
                        aws_signature_version: 4
                        path_style: true
                        endpoint: "{{ .endpoint }}"
                        region: "{{ .region }}"
                        aws_access_key_id: "{{ .accessKey }}"
                        aws_secret_access_key: "{{ .secretKey }}"
                      secretkey: '{{ .secretkey }}'
                    type: Opaque
              - dataFrom:
                - extract:
                    key: salamandre/gitlab/s3
                name: backup
                target:
                  template:
                    data:
                      config: |-
                        host_base = {{ .endpoint }}
                        host_bucket = {{ .endpoint }}
                        bucket_location = {{ .region }}
                        access_key = {{ .accessKey }}
                        secret_key = {{ .secretKey }}
                        signature_v2 = false
                    type: Opaque
              - dataFrom:
                - extract:
                    key: salamandre/gitlab/oidc
                name: oidc
                target:
                  template:
                    data:
                      provider: |-
                        name: openid_connect
                        label: Keycloak
                        args:
                          name: openid_connect
                          scope: ["openid", "profile", "email"]
                          response_type: code
                          issuer: "{{ .issuer }}"
                          client_auth_method: query
                          discovery: true
                          uid_field: preferred_username
                          client_options:
                            identifier: "{{ .clientID }}"
                            secret: "{{ .clientSecret }}"
                            redirect_uri: "https://git.sebtiz13.fr/users/auth/openid_connect/callback"
                    type: Opaque
            gitlab:
              gitlab:
                gitaly:
                  persistence:
                    size: 10Gi
                  resources:
                    limits:
                      cpu: 400m
                      memory: 512Mi
                    requests:
                      cpu: 100m
                      memory: 256Mi
                gitlab-exporter:
                  resources:
                    limits:
                      cpu: 1000m
                      memory: 2Gi
                    requests:
                      cpu: 75m
                      memory: 100Mi
                gitlab-pages:
                  resources:
                    limits:
                      cpu: 1000m
                      memory: 2Gi
                    requests:
                      cpu: 10m
                      memory: 16Mi
                gitlab-shell:
                  maxReplicas: 2
                  minReplicas: 1
                  resources:
                    limits:
                      cpu: 500m
                      memory: 384Mi
                    requests:
                      cpu: 5m
                      memory: 30Mi
                  service:
                    type: LoadBalancer
                kas:
                  maxReplicas: 10
                  minReplicas: 1
                  resources:
                    limits:
                      cpu: 500m
                      memory: 256M
                    requests:
                      cpu: 100m
                      memory: 64M
                sidekiq:
                  resources:
                    limits:
                      cpu: 1500m
                      memory: 3Gi
                    requests:
                      cpu: 300m
                      memory: 1.5Gi
                toolbox:
                  backups:
                    cron:
                      enabled: true
                      resources:
                        requests:
                          cpu: 50m
                          memory: 350Mi
                      schedule: 0 1 * * *
                    objectStorage:
                      config:
                        secret: gitlab-backup
                  enabled: true
                  replicas: 1
                webservice:
                  maxReplicas: 2
                  minReplicas: 1
                  resources:
                    limits:
                      cpu: 1000m
                      memory: 3Gi
                    requests:
                      cpu: 300m
                      memory: 1.5Gi
                  workhorse:
                    resources:
                      limits:
                        cpu: 100m
                        memory: 100Mi
                      requests:
                        cpu: 100m
                        memory: 100Mi
              gitlab-runner:
                gitlabUrl: http://gitlab-webservice-default.gitlab.svc:8181
                replica: 1
                runnerRegistrationToken: <path:salamandre/data/gitlab/runner#registrationToken>
                runners:
                  cache:
                    secretName: gitlab-storage
                  config: |
                    [[runners]]
                      environment = ["container=docker"]
                      [runners.kubernetes]
                        namespace = "gitlab"
                        image = "ubuntu:18.04"
                      [runners.cache]
                        Type = "s3"
                        Shared = true
                        [runners.cache.s3]
                          ServerAddress = "<path:salamandre/data/gitlab/s3#endpoint>"
                          BucketName = "<path:salamandre/data/gitlab/s3#bucket_runner>"
                          BucketLocation = "<path:salamandre/data/gitlab/s3#region>"
                          Insecure = true
                  locked: false
                unregisterRunners: false
              global:
                appConfig:
                  artifacts:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_artifacts>
                    connection:
                      secret: gitlab-storage
                  backups:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_backups>
                    tmpBucket: tmp
                  dependencyProxy:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_depsProxy>
                    connection:
                      secret: gitlab-storage
                    enabled: true
                  initialDefaults:
                    signupEnabled: false
                  lfs:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_lfs>
                    connection:
                      secret: gitlab-storage
                  omniauth:
                    allowBypassTwoFactor:
                    - openid_connect
                    allowSingleSignOn:
                    - openid_connect
                    autoLinkUser:
                    - openid_connect
                    blockAutoCreatedUsers: false
                    enabled: true
                    providers:
                    - secret: gitlab-oidc
                  packages:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_packages>
                    connection:
                      secret: gitlab-storage
                  terraformState:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_tfState>
                    connection:
                      secret: gitlab-storage
                    enabled: true
                  uploads:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_uploads>
                    connection:
                      secret: gitlab-storage
                hosts:
                  domain: sebtiz13.fr
                  gitlab:
                    name: git.sebtiz13.fr
                  https: true
                  kas:
                    name: kas.sebtiz13.fr
                  pages:
                    name: pages.sebtiz13.fr
                ingress:
                  annotations: null
                  enabled: true
                  tls:
                    enabled: true
                    secretName: sebtiz13-fr-tls
                  traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
                  traefik.ingress.kubernetes.io/router.middlewares: traefik-redirect-https@kubernetescrd
                pages:
                  accessControl: true
                  enabled: true
                  objectStore:
                    bucket: <path:salamandre/data/gitlab/s3#bucket_pages>
                    connection:
                      secret: gitlab-storage
                    proxy_download: true
                psql:
                  applicationName: gitlab
                  database: <path:salamandre/data/gitlab/database#database>
                  host: <path:salamandre/data/gitlab/database#host>
                  password:
                    key: postgresql-password
                    secret: gitlab-credentials
                    useSecret: true
                  port: 5432
                  preparedStatements: false
                  username: <path:salamandre/data/gitlab/database#user>
                registry:
                  bucket: <path:salamandre/data/gitlab/s3#bucket_registry>
                smtp:
                  address: <path:salamandre/data/smtp#host>
                  domain: <path:salamandre/data/smtp#host>
                  enabled: true
                  password:
                    key: smtp-password
                    secret: gitlab-credentials
                  port: <path:salamandre/data/smtp#port>
                  user_name: <path:salamandre/data/smtp#username>
                time_zone: Europe/Paris
              redis:
                master:
                  resources:
                    limits:
                      cpu: 200m
                      memory: 128Mi
                    requests:
                      cpu: 30m
                      memory: 50Mi
                metrics:
                  enabled: false
              registry:
                hpa:
                  maxReplicas: 10
                  minReplicas: 1
                resources:
                  limits:
                    cpu: 200m
                    memory: 1Gi
                  requests:
                    cpu: 10m
                    memory: 32Mi
              resources:
                limits:
                  cpu: 500m
                  memory: 256Mi
                requests:
                  cpu: 100m
                  memory: 128Mi
              upgradeCheck:
                enabled: false
  destination:
    name: in-cluster
    namespace: gitlab
  syncPolicy:
    automated: 
      prune: true
      selfHeal: true
