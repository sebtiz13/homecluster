---
# Source: common-app/templates/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: salamandre-minio
  labels:
    helm.sh/chart: common-app-0.0.1
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
    sebtiz13.fr/host: s3.sebtiz13.fr
spec:
  project: infrastructure
  source:
    repoURL: https://charts.min.io/
    chart: minio
    targetRevision: 5.0.3
    plugin:
      env:
        - name: HELM_RELEASE_NAME
          value: minio
        - name: HELM_VALUES
          value: |
            buckets:
            - name: tmp
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_artifacts>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_backups>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_depsProxy>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_packages>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_pages>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_registry>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_runner>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_tfState>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_uploads>
              policy: none
            - name: <path:salamandre/data/gitlab/s3#bucket_lfs>
              policy: none
            consoleIngress:
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: websecure
              enabled: true
              hosts:
              - console.s3.sebtiz13.fr
              tls:
              - hosts:
                - console.s3.sebtiz13.fr
                secretName: sebtiz13-fr-tls
            environment:
              MINIO_BROWSER_REDIRECT_URL: https://console.s3.sebtiz13.fr
            ingress:
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: websecure
              enabled: true
              hosts:
              - s3.sebtiz13.fr
              path: /
              tls:
              - hosts:
                - s3.sebtiz13.fr
                secretName: sebtiz13-fr-tls
            makeServiceAccountJob:
              annotations:
                argocd.argoproj.io/hook: PostSync
                argocd.argoproj.io/hook-delete-policy: HookSucceeded
            mode: standalone
            persistence:
              size: 10Gi
            resources:
              limits:
                cpu: 1000m
                memory: 1Gi
              requests:
                cpu: 10m
                memory: 192Mi
            rootPassword: <path:salamandre/data/minio/auth#rootPassword>
            rootUser: <path:salamandre/data/minio/auth#rootUser>
            svcaccts:
            - accessKey: <path:salamandre/data/gitlab/s3#accessKey>
              policy:
                statements:
                - actions:
                  - s3:AbortMultipartUpload
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:PutObject
                  - s3:ListMultipartUploadParts
                  resources:
                  - arn:aws:s3:::gitlab-*/*
                  - arn:aws:s3:::git-lfs/*
                  - arn:aws:s3:::tmp/*
              secretKey: <path:salamandre/data/gitlab/s3#secretKey>
              user: <path:salamandre/data/minio/auth#rootUser>
            users: []
  destination:
    name: in-cluster
    namespace: minio
  syncPolicy:
    automated: 
      prune: true
      selfHeal: true
