# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json

charts:lint-web:
  stage: test
  image:
    name: alpine/helm:3.10.1
    entrypoint: [""]
  script:
    - ./scripts/all-charts.sh ./scripts/lint.sh
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"

charts:lint:
  stage: test
  image:
    name: alpine/helm:3.10.1
    entrypoint: [""]
  script:
    - ./scripts/diff-charts.sh ./scripts/lint.sh
  rules:
    - changes: # Exclude `charts/common-app`
        - charts/common-app/**/*
      when: never
    - changes:
        - charts/**/*

charts:publish:
  stage: deploy
  needs: [charts:lint]
  image:
    name: alpine/helm:3.10.1
    entrypoint: [""]
  before_script:
    - helm repo add --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD my-repo ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/${HELM_CHANNEL}
    - helm plugin install https://github.com/chartmuseum/helm-push
  script:
    -  ./scripts/diff-charts.sh ./scripts/deploy-chart.sh
  rules:
    - changes: # Exclude `charts/common-app`
        - charts/common-app/**/*
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - charts/**/*
